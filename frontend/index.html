<!DOCTYPE html>
<html lang="en">
<head>
    <title>Turnix UI</title>
    <link rel="icon" type="image/svg" href="./logo.svg">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "uuidv7": "/vendor/uuidv7/index.js"
            }
        }
    </script>
    <div id="app">
        <h1>Turnix GM Starter</h1>
        <div id="mods-status"></div>
        <pre id="log"></pre>
    </div>
<script type="module">
    // TODO: Make this configurable
    globalThis.__turnixDevMode = true;

        // Makes turnixImport work
    await import("/core/turnixImport.js").then((mod) => {
        Object.defineProperty(globalThis, "turnixImport", {
            value: mod.turnixImport,
            writable: false,
            configurable: false,
        });
    });

    // Support for easier console debugging in V8 based engines
    // Makes devtools output more useful object representation in console.log
    (function () {
        const isV8 = (() => {
            return typeof Intl === "object" &&
                   typeof Intl.v8BreakIterator === "object";
        })();

        const isChrome = (() => {
            return !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime);
        })();
        
        // Do not replace console.log outside of Chrome/V8
        if(!(isChrome && isV8)) return;

        const originalLog = console.log;

        function flattenForPreview(obj, depth = 1) {
            if(typeof obj !== "object" || obj === null) return obj;

            const copy = Array.isArray(obj) ? [] : {};

            for(const key in obj) {
                if(!Object.prototype.hasOwnProperty.call(obj, key)) continue;
                
                const val = obj[key];
                if(depth <= 0 || typeof val !== "object" || val == null) {
                    copy[key] = val;
                } else {
                    copy[key] = Array.isArray(val)
                        ? `[Array ${val.length}]`
                        : "[Object]";
                }
            }

            return copy;
        }

        console.log = function(...args) {
            const newArgs = args.map(arg => {
                if(typeof arg === "object" && arg !== null) {
                    return flattenForPreview(arg);
                }
                return arg;
            });

            originalLog.apply(console, newArgs);
        };
    })();

    const { RpcClient } = await turnixImport('/assets/rpc-client.js');
    const { loadMods } =  await turnixImport('/assets/mod-loader.js');

    const wsUrl = (location.origin.replace(/^http/, 'ws')) + '/ws'
    const settings = await fetch('/settings').then(response=>response.json())
    const rpc = await RpcClient.connect(wsUrl, { settings });
    globalThis.Turnix = {rpc, settings};

    const loaded = await loadMods({rpc, settings});
    document.getElementById('mods-status').textContent =
        loaded.length ? `Loaded mods: ${loaded.map(m => m.manifest.name).join(',')}` : 'No mods loaded';
    console.log('Mods loaded.')
</script>
</body>
</html>
