<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Turnix UI</title>
        <link rel="icon" type="image/svg+xml" href="./logo.svg">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- Hint user agents we support dark UIs + let them render form controls correctly -->
        <meta name="color-scheme" content="dark light">
        <!-- Helps mobile address bar blend with the app theme (adjust to --bg color) -->
        <meta name="theme-color" content="#0b0d12">
        <link rel="stylesheet" href="./assets/style.css">
    </head>
    <body>
        <a class="skip-link" href="#turnix-contents">Skip to main content</a>
        <noscript><div class="noscript">JavaScript is required to run Turnix UI.</div></noscript>
        <script type="importmap">
            {
                "imports": {
                    "uuidv7": "./vendor/uuidv7/index.js"
                }
            }
        </script>

        <div class="container column-mode">
            <div class="panel top"    id="turnix-top"      role="region" aria-label="Top panel"></div>
            <div class="panel left"   id="turnix-left"     role="region" aria-label="Left panel"></div>
            <main class="contents"    id="turnix-contents" tabindex="-1"></main>
            <div class="panel right"  id="turnix-right"    role="region" aria-label="Right panel"></div>
            <div class="panel bottom" id="turnix-bottom"   role="region" aria-label="Bottom panel"></div>
        </div>
        <div class="toasts" id="toasts"></div>

        <script type="module">
            // TODO: Make this configurable
            globalThis.__turnixDevMode = true;

            // Makes turnixImport work
            await import('./core/turnixImport.js').then((mod) => {
                Object.defineProperty(globalThis, 'turnixImport', {
                    value: mod.turnixImport,
                    writable: false,
                    configurable: false,
                });
                return;
            });

            // Support for easier console debugging in V8 based engines
            // Makes devtools output more useful object representation in console.*
            // TODO: Make this toggleable with settings option
            (function () {
                const isV8 = typeof Intl === 'object' && typeof Intl.v8BreakIterator === 'object';
                const isChrome = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime);
                
                // Do not replace console functions outside of Chrome/V8
                if(!(isChrome && isV8)) return;
                
                // Prevent double-wrapping on hot reloads
                if(globalThis.__turnixConsoleWrapped) return;
                globalThis.__turnixConsoleWrapped = true;

                function isPlainObject(obj) {
                    return Object.prototype.toString.call(obj) === '[object Object]';
                }

                function transformArg(arg) {
                    if(arg == null || typeof arg !== 'object') return arg;
                    if(arg instanceof Error) return arg; // Don't flatten errors
                    return flattenForPreview(arg, 1);
                }

                // Summarize objects one level deep; preserve Errors; avoid circular refs
                function flattenForPreview(obj, depth = 1, seen = new WeakSet()) {
                    if(typeof obj !== 'object' || obj === null) return obj;
                    if(obj instanceof Error) return obj; // Keep full Error objects
                    if(seen.has(obj)) return '[Circular]';
                    seen.add(obj);

                    // Special cases for common containers
                    if(Array.isArray(obj)) return `[Array ${obj.length}]`;
                    else if(obj instanceof Map) return `[Map ${obj.size}]`;
                    else if(obj instanceof Set) return `[Set ${obj.size}]`;
                    else if(obj instanceof Date) return obj.toISOString();
                    else if(obj instanceof RegExp) return obj.toString();
                    else if(!isPlainObject(obj)) return `[${obj.constructor?.name || 'Object'}]`;
                    
                    const out = {};
                    for(const key of Object.keys(obj)) {
                        const val = obj[key];
                        if(depth <= 0 || typeof val !== 'object' || val == null || val instanceof Error) {
                            out[key] = val;
                        } else {
                            // Summarize nested structures
                            if(Array.isArray(val)) out[key] = `[Array ${val.length}]`;
                            else if(val instanceof Map) out[key] = `[Map ${val.size}]`;
                            else if(val instanceof Set) out[key] = `[Set ${val.size}]`;
                            else if(val instanceof Date) out[key] = val.toISOString();
                            else if(val instanceof RegExp) out[key] = val.toString();
                            else if(isPlainObject(val)) out[key] = '[Object]';
                            else out[key] = `[${val?.constructor?.name || 'Object'}]`;
                        }
                    }
                    
                    return out;
                }

                const methods = ['log', 'debug', 'info', 'warn', 'error'];
                for(const mthd of methods) {
                    const original = console[mthd];
                    if(typeof original !== 'function') continue;
                    console[mthd] = function(...args) {
                        try {
                            const transformedArgs = args.map(transformArg);
                            original.apply(console, transformedArgs);
                        } catch {
                            // If anything goes sideways, fall back to original args
                            original.apply(console, args);
                        }
                    };
                }
            })();

            await turnixImport('./bootstrap.js');
        </script>
    </body>
</html>
