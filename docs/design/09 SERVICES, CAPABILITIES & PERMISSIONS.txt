======================================================================
DESIGN AREA 9 — SERVICES, CAPABILITIES & PERMISSIONS
======================================================================

Status:
-------
CORE — this area defines *how packs interact at runtime* without
importing code, and how Turnix mediates power, access, and safety.

This is the primary cross-pack interaction mechanism.


----------------------------------------------------------------------
1. CORE CONCEPT
----------------------------------------------------------------------

Turnix distinguishes between:

- Services     → concrete runtime objects / instances
- Capabilities → named, permissioned actions

They are related but NOT the same.

Neither Services nor Capabilities imply persistence.
Persistence is governed exclusively by IoManager and Config (DA-10, DA-11).


----------------------------------------------------------------------
2. SERVICES (LOCKED DEFINITION)
----------------------------------------------------------------------

A Service is:
- a runtime object
- registered by a pack during activation
- stored in a scoped service registry
- retrieved by other packs at runtime

Example:
    ctx.registerService("llm", client)
    client = ctx.services.get("llm")

Properties:
- services are opaque objects
- lifetime = activation scope
- no automatic permission checks
- name collisions are forbidden
- services MUST NOT perform filesystem I/O directly


----------------------------------------------------------------------
3. SERVICE ACCESS RULES (LOCKED)
----------------------------------------------------------------------

- Service access is explicit
- No inheritance
- No visibility-based granting
- No implicit availability

If service does not exist:
- ctx.services.get(name) → error (or None if explicitly allowed)

Services are for trusted runtime wiring only.
They MUST NOT be used as a substitute for configuration or persistence.


----------------------------------------------------------------------
4. CAPABILITIES (LOCKED DEFINITION)
----------------------------------------------------------------------

A Capability is:
- a named operation
- exposed by a pack
- callable by other packs
- mediated by Turnix
- permission-checked

Example:
    ctx.registerCapability("llm.pipeline@1", handler)

Call site:
    ctx.callCapability("llm.pipeline@1", args)

Capabilities are the ONLY allowed cross-pack execution boundary.


----------------------------------------------------------------------
5. CAPABILITY NAMES & VERSIONING (LOCKED)
----------------------------------------------------------------------

Capability identifiers:
    <name>@<major>

Examples:
    "llm.pipeline@1"
    "http.request@1"
    "compile.typescript@1"

Rules:
- major version only
- incompatible change → new major
- no minor/patch in identifier


----------------------------------------------------------------------
6. CAPABILITY EXPORT & IMPORT (LOCKED DISTINCTION)
----------------------------------------------------------------------

Export:
- happens in code via ctx.registerCapability
- manifest declaration OPTIONAL (bookkeeping only)

Import / usage:
- happens in code via ctx.callCapability
- manifest declaration OPTIONAL but RECOMMENDED

Manifest data is advisory, not authoritative.


----------------------------------------------------------------------
7. PERMISSIONS MODEL (LOCKED CORE)
----------------------------------------------------------------------

Capabilities may require permission.

Permission classes:
- none  → always allowed
- soft  → user may be asked, allow/deny/always
- hard  → user MUST explicitly allow

Classification is capability-defined and immutable per major version.


----------------------------------------------------------------------
8. PERMISSION FLOW (LOCKED BEHAVIOR)
----------------------------------------------------------------------

When a capability is invoked:

1) Permission is checked
2) If allowed → handler executes
3) If undecided:
    - execution PAUSES
    - UI prompt is shown
    - user decision resumes execution

Turnix MUST remain responsive while waiting.
No background mutation may occur during pause.


----------------------------------------------------------------------
9. USER DECISIONS & POLICY (LOCKED)
----------------------------------------------------------------------

User decisions:
- may be persisted
- may be scoped (session / app / global)
- must be explainable
- must be reversible

Policies may allow:
- auto-allow soft permissions
- never auto-allow hard permissions

Decisions MUST be traceable.


----------------------------------------------------------------------
10. CAPABILITIES VS SERVICES (LOCKED SEPARATION)
----------------------------------------------------------------------

Services:
- direct object access
- no permission layer
- internal wiring only

Capabilities:
- controlled boundary
- user-facing power
- audited, traced, permissioned

Both may coexist in the same pack.
Capabilities MUST NOT expose service internals directly.


----------------------------------------------------------------------
11. COMPUTED TRANSFORMS & REACTIVE BEHAVIOR (LOCKED CLARIFICATION)
----------------------------------------------------------------------

Some packs may react to changes in configuration or state by:

- observing values
- computing derived behavior
- adjusting runtime output

Rules:
- such behavior MUST be runtime-only
- MUST NOT mutate stored config or memory
- MUST NOT intercept persistence
- MUST NOT replace the config source of truth

Reactive behavior may be implemented via:
- capability invocation
- service cooperation
- config.watch-style notifications (defined in DA-11), without 
  acquiring mutation authority

This preserves:
- determinism
- reversibility
- non-invasive overrides (e.g. accessibility scaling)


----------------------------------------------------------------------
12. OVERRIDING & CONFLICTS (LOCKED PRINCIPLE)
----------------------------------------------------------------------

Multiple packs exporting the same capability:
- NOT allowed by default
- conflict MUST be detected
- user choice or hard error required

Silent override is forbidden.


----------------------------------------------------------------------
13. TRACE & AUDIT (LOCKED)
----------------------------------------------------------------------

All capability calls:
- are traceable
- include caller identity
- include permission context
- may be logged

Trace MUST distinguish:
- stored mutation
- computed effect
- denied access

This is critical for debugging and trust.


----------------------------------------------------------------------
14. DEVELOPMENT-TIME REPORTING (LOCKED)
----------------------------------------------------------------------

At end of run (dev mode):

- report declared-but-unused capabilities
- report used-but-undeclared capabilities
- report exported-but-never-called capabilities

Informational only, non-fatal.


----------------------------------------------------------------------
15. JAVASCRIPT & PYTHON SYMMETRY (LOCKED)
----------------------------------------------------------------------

Same concepts apply to both runtimes:
- services registered in Python usable by JS via capability
- JS UI triggers Python services via capability
- no direct cross-language object access


----------------------------------------------------------------------
16. OPEN QUESTIONS
----------------------------------------------------------------------

OPEN:
- fine-grained permission scopes
- capability discovery UI
- dynamic capability revocation
- subscription-based capabilities


----------------------------------------------------------------------
17. LOCKED SUMMARY
----------------------------------------------------------------------

LOCKED:
- services = runtime wiring only
- capabilities = permissioned execution boundary
- no implicit persistence
- no silent overrides
- computed behavior is non-mutating
- full tracing & audit

OPEN:
- UX extensions
- advanced permission policies


----------------------------------------------------------------------
END OF DESIGN AREA 9
----------------------------------------------------------------------
